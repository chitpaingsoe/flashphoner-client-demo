<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../../dependencies/bootstrap/css/bootstrap.css">
    <link rel="stylesheet" href="../../dependencies/bootstrap/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="conference.css">
    <title>Conference</title>
     <!-- Load TensorFlow.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.2"></script>
  <!-- Load BodyPix -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix@2.0"></script>

  <!-- ayame -->
  <script src="https://unpkg.com/@open-ayame/ayame-web-sdk@19.9.0/dist/ayame.min.js"></script>
  <script>
    const signalingUrl = 'wss://ayame-lite.shiguredo.jp/signaling';
    const defaultRoomId = 'bodypix-test-room';
    let ayameConn = null;
  </script>
    <script type="text/javascript" src="../../../../flashphoner.js"></script>
    <script type="text/javascript" src="../../dependencies/jquery/jquery-1.12.0.js"></script>
    <script type="text/javascript" src="../../dependencies/js/utils.js"></script>

    <script type="text/javascript" src="conference.js"></script>
    <!-- Bootstrap JS -->
    <script src="../../dependencies/bootstrap/js/bootstrap.js"></script>
    <script>var _participants = 3</script>
</head>
<body onload="init_page()">
<div class="container">
    <div class="row">

        <h2 id="notifyFlash" class="text-danger"></h2>

        <div class="col-sm-9 text-center">
            <h2 class="text-center">Conference</h2>
        </div>

        <div class="col-sm-9 text-center">
            <form class="form-horizontal" role="form" style="margin-top: 10px">
                <div id="connForm" class="form-group">
                    <label class="col-sm-2 control-label">WCS URL</label>
                    <div class="col-sm-4">
                        <input type="text" class="form-control" id="url">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label">Login</label>
                    <div class="col-sm-4">
                        <input type="text" class="form-control" id="login">
                    </div>
                    <div class="col-sm-2 text-right">
                        <button id="joinBtn" type="button" class="btn btn-default">Join</button>
                    </div>
                    <div class="col-sm-4 text-left">
                        <div id="status"></div>
                    </div>
                    <div class="col-sm-4 text-left text-danger">
                        <div id="failedInfo"></div>
                    </div>
                </div>
            </form>
        </div>

        <div class="col-sm-9 text-center">

            <div class="col-sm-6">
                <div class="fp-remoteVideo">
                    <div id="participant1Display" class="display"></div>
                </div>
                <div id="participant1Name" class="text-center text-muted">NONE</div>
                <div class="text-center" style="margin-top: 20px">
                    <div id="participant1Status"></div>
                </div>
            </div>

            <div class="col-sm-6">
                <div class="fp-remoteVideo">
                    <div id="participant2Display" class="display"></div>
                </div>
                <div id="participant2Name" class="text-center text-muted">NONE</div>
                <div class="text-center" style="margin-top: 20px">
                    <div id="participant2Status"></div>
                </div>
            </div>

        </div>
        <div class="col-sm-9 text-center">
            <div style="display:grid; grid-template-rows: 1fr; grid-template-columns: 170px 170px;">
    <div style="grid-column:2;">
    
	<div style="display:grid; grid-template-rows: 1fr; grid-template-columns: 170px 170px;">
		<div style="grid-column: 1;">
			<video id="local_video" width="640px" height="480px" muted
				style="border: solid black 1px; width:160px; height:120px" hidden></video>
		</div>
		<div style="grid-column:2;">
			<canvas id="canvas" width="640px" height="480px"
				style="border: solid 1px black; width:640px; height:480px;" hidden/>
		</div>
	</div>
    </div> 
  </div>
            <div id="localDisplay" class="fp-localVideo"></div>           
            <div class="text-center" style="margin-top: 20px">
                <div id="localStatus"></div>
            </div>
            <div class="input-group col-sm-10" style="margin: 10px auto 0 auto;">
                <button id="localAudioToggle" type="button" class="btn btn-default">Mute A</button>
                <button id="localVideoToggle" type="button" class="btn btn-default">Mute V</button>
            </div>
            <div class="input-group col-sm-10" style="margin: 10px auto 0 auto;">
                <button id="localStopBtn" type="button" class="btn btn-default">Publish</button>
            </div>

        </div>
        <div class="col-sm-9" style="margin-top: 20px">
            <div class="form-group">
                <div id="chat" style="overflow-y: scroll; height: 100px;" class="text-left form-control"></div>
            </div>
        </div>
        <div class="col-sm-9">
            <div class="form-group">
                <textarea id="message" class="form-control" rows="1" style="resize: none;"></textarea>
            </div>
        </div>
        <div class="col-sm-9">
            <div class="pull-right">
                <button id="sendMessageBtn" type="button" class="btn btn-default">Send</button>
            </div>
        </div>

        <div class="col-sm-9" style="margin-top: 20px">
            <span class="text-muted text-left">Invite</span>
            <div id="inviteAddress" class="text-muted text-center" style="border: 1px solid">Not connected</div>
        </div>
    </div>
    <div class="row" style="margin-top: 70px;">
        <div class="col-sm-4">
            <a href="https://play.google.com/store/apps/details?id=com.flashphoner.wcsexample.conference"><img src="../../dependencies/img/google_play.jpg" title="Google Play" alt="Google Play"></a>
        </div>
    </div>
</div>
 <script>
		const localVideo = document.getElementById('local_video');
		const remoteVideo = document.getElementById('remote_video');
		const canvas = document.getElementById('canvas');
		const maskRadioGroup = document.getElementById('mask_radio_broup');
		const roomIdInput = document.getElementById('room_id');

		let localStream = null;
		let canvasStream = null;
		let bodyPixNet = null;
		let animationId = null;
		let contineuAnimation = false;
		let bodyPixMaks = null;
		let segmentTimerId = null;
		let isConnected = false;
		let maskType = 'room';

		// ------- bodypix -------
		async function loadModel() {
			const net = await bodyPix.load(/** optional arguments, see below **/);
			bodyPixNet = net;
			console.log('bodyPix ready');
			updateUI();
		}
		loadModel();

		function setMask(type) {
			maskType = type;
		}

		function updateSegment() {
			const segmeteUpdateTime = 10; // ms
			if (!bodyPixNet) {
				console.warn('bodyPix net NOT READY');
				return;
			}

			const option = {
				flipHorizontal: false,
				internalResolution: 'medium',
				segmentationThreshold: 0.7,
				maxDetections: 4,
				scoreThreshold: 0.5,
				nmsRadius: 20,
				minKeypointScore: 0.3,
				refineSteps: 10,
				estimate: 'segmentation'
			};

			if (maskType === 'none') {
				bodyPixMaks = null;
				if (contineuAnimation) {
					segmentTimerId = setTimeout(updateSegment, segmeteUpdateTime);
				}
				return;
			}

			bodyPixNet.segmentPerson(localVideo, option)
				.then(segmentation => {
					if (maskType === 'room') {
						const fgColor = { r: 0, g: 0, b: 0, a: 0 };
						const bgColor = { r: 127, g: 127, b: 127, a: 255 };
						const personPartImage = bodyPix.toMask(segmentation, fgColor, bgColor);
						bodyPixMaks = personPartImage;
					}
					else if (maskType === 'person') {
						const fgColor = { r: 127, g: 127, b: 127, a: 255 };
						const bgColor = { r: 0, g: 0, b: 0, a: 0 };
						const roomPartImage = bodyPix.toMask(segmentation, fgColor, bgColor);
						bodyPixMaks = roomPartImage;
					}
					else {
						bodyPixMaks = null;
					}

					if (contineuAnimation) {
						segmentTimerId = setTimeout(updateSegment, segmeteUpdateTime);
					}
				})
				.catch(err => {
					console.error('segmentPerson ERROR:', err);
				})
		}

		function startCanvasVideo() {
			writeCanvasString('initalizing BodyPix');
			contineuAnimation = true;
			animationId = window.requestAnimationFrame(updateCanvas);
			canvasStream = canvas.captureStream();

			updateSegment();
			updateUI();
		}

		function writeCanvasString(str) {
			const ctx = canvas.getContext('2d');
			ctx.font = "64px serif";
			ctx.fillText(str, 5, 100);
			console.log(str);
		}

		function stopCanvasVideo() {
			contineuAnimation = false;
			if (segmentTimerId) {
				clearTimeout(segmentTimerId);
				segmentTimerId = null;
			}

			if (canvasStream) {
				canvasStream.getTracks().forEach(track => {
					console.log('stop canvas track:', track);
					track.stop();
				});
				canvasStream = null;
			}

			updateUI();
		}

		function updateCanvas() {
			drawCanvas(localVideo);
			if (contineuAnimation) {
				animationId = window.requestAnimationFrame(updateCanvas);
			}
		}

		function drawCanvas(srcElement) {
			const opacity = 1.0;
			const flipHorizontal = false;
			//const maskBlurAmount = 0;
			const maskBlurAmount = 3;

			// Draw the mask image on top of the original image onto a canvas.
			// The colored part image will be drawn semi-transparent, with an opacity of
			// 0.7, allowing for the original image to be visible under.
			bodyPix.drawMask(
				canvas, srcElement, bodyPixMaks, opacity, maskBlurAmount,
				flipHorizontal
			);
		}

		// -------- user media -----------

		async function startVideo() {
			//const mediaConstraints = {video: true, audio: true}; 
			//const mediaConstraints = {video: true, audio: false}; 
			const mediaConstraints = { video: { width: 640, height: 480 }, audio: true };
			disableElement('start_video_button');

			localStream = await navigator.mediaDevices.getUserMedia(mediaConstraints).catch(err => {
				console.error('media ERROR:', err);
				enableElement('start_video_button');
				return;
			});

			localVideo.srcObject = localStream;
			await localVideo.play().catch(err => console.error('local play ERROR:', err));

			startCanvasVideo();
			updateUI();
			
		}

		function stopVideo() {
			stopCanvasVideo();

			localVideo.pause();
			localVideo.srcObject = null;
			if (localStream) {
				localStream.getTracks().forEach(track => {
					console.log('stop track:', track);
					track.stop();
				});
				localStream = null;
			}

			updateUI();
		}

		// -------- ayame -----------
		async function connect() {
			if (!localStream) {
				console.warn('localStream NOT READY');
				return;
			}
			let roomId = roomIdInput.value;
			if ((!roomId) || (roomId === '')) {
				roomId = defaultRoomId
			}

			if (!ayameConn) {
				ayameConn = Ayame.connection(signalingUrl, roomId);
			}

			if (!canvasStream) {
				console.warn('canvas stream NOT READY');
				return;
			}
			await ayameConn.connect(canvasStream);
			console.log('ayame connected. state=', ayameConn.connectionState);

			ayameConn.on('connect', () => {
				console.log('ayame connected. ayame state=', ayameConn.connectionState);
			});
			ayameConn.on('disconnect', (e) => {
				console.warn('ayame disconnect:', e);
				console.log('ayame state=', ayameConn.connectionState);
				if (remoteVideo.srcObject) {
					remoteVideo.pause();
					remoteVideo.srcObject = null;
				}

				ayameConn.disconnect();
				isConnected = false;
				updateUI();
			});
			ayameConn.on('addstream', async (e) => {
				console.log('add stream. ayame state=', ayameConn.connectionState);
				remoteVideo.srcObject = e.stream;
				await remoteVideo.play().catch(err => console.warn('remote play ERROR:', err));
			});
			ayameConn.on('removestream', () => {
				console.log('remove stream. ayame state=', ayameConn.connectionState);
				remoteVideo.pause();
				remoteVideo.srcObject = null;
			});

			isConnected = true;
			updateUI();
		}

		function disconnect() {
			if (!ayameConn) {
				return;
			}
			ayameConn.disconnect();
			console.log('disconneting. ayame state=', ayameConn.connectionState);

			if (remoteVideo.srcObject) {
				remoteVideo.pause();
				remoteVideo.srcObject = null;
			}

			isConnected = false;
			updateUI();
		}

		// --- UI control ----
		function updateUI() {
			if (localStream) {
				disableElement('start_video_button');

				if (isConnected) {
					disableElement('stop_video_button');
					disableElement('connect_button');
					enabelElement('disconnect_button');
				}
				else {
					enabelElement('stop_video_button');
					enabelElement('connect_button');
					disableElement('disconnect_button');
				}
			}
			else {
				enabelElement('start_video_button');
				disableElement('stop_video_button');

				disableElement('connect_button');
				disableElement('disconnect_button');
			}

			if (bodyPixNet && localStream) {
				if (isConnected) {
					disableElement('start_canvas_button');
					disableElement('stop_canvas_button');
				}
				else {
					if (canvasStream) {
						disableElement('start_canvas_button');
						enabelElement('stop_canvas_button');
					}
					else {
						enabelElement('start_canvas_button');
						disableElement('stop_canvas_button');
					}
				}
			}
			else {
				disableElement('start_canvas_button');
				disableElement('stop_canvas_button');
			}

			if (ayameConn) {
				disableElement('room_id');
			}
			else {
				enabelElement('room_id');
			}
		}

		function enabelElement(id) {
			const element = document.getElementById(id);
			if (element) {
				element.removeAttribute('disabled');
			}
		}

		function disableElement(id) {
			const element = document.getElementById(id);
			if (element) {
				element.setAttribute('disabled', '1');
			}
		}

		updateUI();
	</script> 
</body>
</html>